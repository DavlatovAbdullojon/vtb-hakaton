<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ - Banker Portal</title>
    <link rel="stylesheet" href="../client/theme-styles.css">
    <style id="sidebar-styles"></style>
    <style>
        /* Page-specific styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
            transform: translateY(0);
            transition: transform var(--duration-fast) var(--easing-standard), box-shadow var(--duration-fast) var(--easing-standard);
        }

        .stat-card::before {
            content: "";
            position: absolute;
            inset: 0;
            pointer-events: none;
            background: linear-gradient(90deg, rgba(15,118,110,0.10), rgba(245,158,11,0.08) 60%, transparent 100%);
            opacity: 0.6;
            mask-image: radial-gradient(400px 160px at 10% 0, black, transparent 70%);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .section {
            background: var(--bg-secondary);
            padding: 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
        }

        .section h2 {
            margin-bottom: 20px;
            color: var(--text-primary);
            font-size: 22px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 12px;
            overflow: hidden;
        }

        th {
            text-align: left;
            padding: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
            font-family: var(--font-display);
            letter-spacing: 0.01em;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        tr:hover {
            background: var(--bg-primary);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.02em;
        }
        .status-ok { background: rgba(22,163,74,.12); color: #16a34a; }
        .status-proc { background: rgba(245,158,11,.14); color: #d97706; }
        .status-fail { background: rgba(180,35,24,.14); color: #b42318; }

        .refresh-btn {
            position: fixed;
            bottom: 32px;
            right: 32px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--color-accent);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 10px 26px rgba(245, 158, 11, 0.25);
            transition: transform var(--duration-fast) var(--easing-standard), box-shadow var(--duration-fast) var(--easing-standard), background var(--duration-fast) var(--easing-standard);
            z-index: 1000;
        }

        .refresh-btn:hover {
            transform: translateY(-2px) rotate(180deg);
            box-shadow: 0 14px 34px rgba(245, 158, 11, 0.32);
        }
    </style>
</head>
<body>
    <!-- Main Content -->
    <main class="main-content">
        <div class="top-bar">
            <div class="top-bar-title">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –±–∞–Ω–∫–∞</div>
        </div>

        <div class="content-area">
            <div class="container">
                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card reveal is-visible">
                        <div class="stat-label">üí∞ –ö–∞–ø–∏—Ç–∞–ª –±–∞–Ω–∫–∞</div>
                        <div class="stat-value" id="capital">‚Äî</div>
                    </div>
                    <div class="stat-card reveal is-visible">
                        <div class="stat-label">üë• –í—Å–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
                        <div class="stat-value" id="clientsCount">‚Äî</div>
                    </div>
                    <div class="stat-card reveal is-visible">
                        <div class="stat-label">üè¶ –í—Å–µ–≥–æ —Å—á–µ—Ç–æ–≤</div>
                        <div class="stat-value" id="accountsCount">‚Äî</div>
                    </div>
                    <div class="stat-card reveal is-visible">
                        <div class="stat-label">üí≥ –û–±—â–∏–π –±–∞–ª–∞–Ω—Å</div>
                        <div class="stat-value" id="totalBalance">‚Äî</div>
                    </div>
                    <div class="stat-card reveal is-visible">
                        <div class="stat-label">üì§ –í—Å–µ–≥–æ –ø–ª–∞—Ç–µ–∂–µ–π</div>
                        <div class="stat-value" id="paymentsCount">‚Äî</div>
                    </div>
                </div>

                <!-- Recent Payments -->
                <div class="section reveal is-visible">
                    <h2>üí≥ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∏</h2>
                    <div id="paymentsContainer">
                        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <button class="refresh-btn" onclick="loadAllData()" title="–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ">üîÑ</button>

    <script type="module">
        import { applyTheme, toggleTheme } from '../client/theme-switcher.js';
        import { initSidebar, sidebarStyles } from './sidebar.js';

        // Apply styles
        document.getElementById('sidebar-styles').textContent = sidebarStyles;
        
        // Initialize sidebar
        initSidebar('monitoring');
        
        // Apply theme
        applyTheme();

        // Setup theme toggle
        document.getElementById('themeToggle').addEventListener('click', () => {
            toggleTheme();
            const isDark = localStorage.getItem('theme') === 'dark';
            document.getElementById('themeIcon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        });

        // Update theme icon on load
        const isDark = localStorage.getItem('theme') === 'dark';
        document.getElementById('themeIcon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
    </script>

    <script>
        // Check authentication
        const token = localStorage.getItem('banker_token');
        if (!token) {
            window.location.href = 'index.html';
        }

        function getBaseUrl() {
            const port = window.location.port;
            return `http://localhost:${port}`;
        }

        // Load all data
        async function loadAllData() {
            await Promise.all([
                loadStats(),
                loadPayments()
            ]);
        }

        // Load stats
        async function loadStats() {
            try {
                const baseUrl = getBaseUrl();

                // Get capital
                const capitalResponse = await fetch(`${baseUrl}/admin/capital`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (capitalResponse.ok) {
                    const data = await capitalResponse.json();
                    const bankData = data.banks[0];
                    document.getElementById('capital').textContent =
                        `${bankData.capital.toLocaleString('ru-RU')} ‚ÇΩ`;
                }

                // Get stats
                const statsResponse = await fetch(`${baseUrl}/admin/stats`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (statsResponse.ok) {
                    const data = await statsResponse.json();
                    document.getElementById('accountsCount').textContent = data.accounts_count;
                    document.getElementById('totalBalance').textContent =
                        `${data.total_balance.toLocaleString('ru-RU')} ‚ÇΩ`;
                    document.getElementById('paymentsCount').textContent = data.payments_count;
                    document.getElementById('clientsCount').textContent = data.clients_count;
                }

            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load payments
        async function loadPayments() {
            try {
                const baseUrl = getBaseUrl();
                const paymentsResponse = await fetch(`${baseUrl}/admin/payments`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (paymentsResponse.ok) {
                    const data = await paymentsResponse.json();
                    const paymentsContainer = document.getElementById('paymentsContainer');
                    paymentsContainer.innerHTML = '';

                    if (data.payments.length === 0) {
                        paymentsContainer.innerHTML = '<p style="color: var(--text-muted);">–ù–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø–ª–∞—Ç–µ–∂–µ–π.</p>';
                        return;
                    }

                    let tableHtml = `
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</th>
                                    <th>–ü–æ–ª—É—á–∞—Ç–µ–ª—å</th>
                                    <th>–°—É–º–º–∞</th>
                                    <th>–î–∞—Ç–∞</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    data.payments.forEach(payment => {
                        const status = (payment.status || '').toLowerCase();
                        const statusClass =
                            status.includes('accepted') || status.includes('completed') ? 'status-ok' :
                            status.includes('process') || status.includes('pending') ? 'status-proc' :
                            'status-fail';
                        tableHtml += `
                            <tr>
                                <td><code style="font-size:12px;">${payment.payment_id.substring(0, 8)}...</code></td>
                                <td>${payment.sender_account_id}</td>
                                <td>${payment.receiver_account_id}</td>
                                <td><strong>${payment.amount.toLocaleString('ru-RU')} ${payment.currency}</strong></td>
                                <td>${new Date(payment.created_at).toLocaleString('ru-RU')}</td>
                                <td><span class="status-badge ${statusClass}">${payment.status}</span></td>
                            </tr>
                        `;
                    });
                    tableHtml += `</tbody></table>`;
                    paymentsContainer.innerHTML = tableHtml;
                }
            } catch (error) {
                console.error('Error loading payments:', error);
                document.getElementById('paymentsContainer').innerHTML = 
                    '<p style="color: var(--danger-color);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π.</p>';
            }
        }

        // Initial load
        loadAllData();
    </script>
</body>
</html>
